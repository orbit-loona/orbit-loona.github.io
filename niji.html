<!DOCTYPE html>
<html lang="en">
	<head>
		<title>niji keyboard</title>
		<meta property="og:site_name" content="orbit-loona.github.io" />
		<meta property="og:type" content="website" />
		<meta property="og:title" content="Niji keyboard" />
		<meta property="og:url" content="https://orbit-loona.github.io/niji.html" />
		<meta property="og:description" content="Type Niji online" />
		<meta property="og:locale" content="en_US" />
		<meta property="og:image" content="https://orbit-loona.github.io/bin/niji.png" />
		<meta property="og:image:width" content="222" />
		<meta property="og:image:height" content="53" />
		<meta property="og:image:alt" content="image" />
		<meta name="twitter:image:src" content="https://orbit-loona.github.io/bin/niji.png" />
		<meta name="twitter:title" content="niji keyboard" />
		<meta name="twitter:description" content="Type Niji online" />
		<link rel="stylesheet" href="main.css"/>
		<meta name="SKYPE_TOOLBAR" content="SKYPE_TOOLBAR_PARSER_COMPATIBLE">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="author" content="An Orbit">
		<meta charset="UTF-8">
		<style>
			@font-face {
				font-family: "Monnaka Plain";
				src: url("neededDueToCorsBullsh1t/MonnakaPlain.ttf");
			}
			
			body, #mainText, #buttons button {
				font-family: 'Gamja Flower', 'Comic Mono', 'Monnaka Plain', 'Arial', sans-serif;
			}
			
			#mainText {
				line-height: 125%;
			}
			
			#buttons, #buttons tr, #buttons td, #buttons th {
				border: 1px solid white;
				max-height: 33px;
			}
			
			#buttons tr {
				width: 100%;
			}
			
			#buttons td, padding: 2px {
				padding: 2px;
			}

			#buttons {
				border-collapse: collapse;
			}
			
			#buttons button, #buttons th div, div.spacer {
				width: 30px;
				height: 30px;
				max-width: 30px;
				max-height: 30px;
				text-align: center;
				overflow: hidden;
			}
			
			#buttons th div {
				display: table-cell;
				vertical-align: middle;
				font-size: 90%;
			}

			#buttons th, #buttons td {
				display: table-cell;
				vertical-align: middle;
				font-size: 90%;
			}

			#buttons tr td:has(div.spacer) {
				border-right: unset;
			}

			#buttons tr.cursed {
				background-color: #922;
			}

			span.cursed, p.cursed {
				color: #e66;
			}

			#buttons tr.cursed button {
				color: #400;
				background-color: #fbb;
				border: 1px solid #a77;
			}

			#buttons button, div.spacer {
				font-size: 110%;
			}
			
			#mainText {
				width: 550px;
				height: 350px;
			}

			a.footnote, a.footnote:visited {
				text-decoration: underline;
				color: #0ff;
			}

			:target {
				background-color: #ffff002f;
				border: 1px solid yellow;
				padding: 8px;
			}
			
			#noSafariMessage {
				background-color: #2f0000;
				color: white;
				border: 1px solid red;
				padding: 8px;
			}
			
			small {
				font-size: 80%;
			}
			
			.tiny {
				font-size: 5%
			}
			
			div#footnotes {
				font-size: 85%
			}
		</style>
		<style id="style2">
			.cursed, .hidden, th.hidden, td.hidden, #buttons th.hidden, #buttons td.hidden {
				display: none;
			}
		</style>
		<script>
			var urlParams = new URLSearchParams(window.location.search);
			
			var doCursed = (urlParams.get("enableCursed") !== null);

			//https://stackoverflow.com/a/16427747
			function isLocalStorageAvailable() {
				var test = 'test';
				try {
					localStorage.setItem(test, test);
					localStorage.removeItem(test);
					return true;
				} catch(e) {
					return false;
				}
			};
			
			var localStorageIsAvailable = isLocalStorageAvailable();
			if(!isLocalStorageAvailable) {
				alert("Local storage is not available. Text will not be saved when you refresh.")
			};

			function saveText() {
				if(!isLocalStorageAvailable) {
					return false
				};
				var _textbox = document.getElementById("mainText");
				if(_textbox) {
					var text = _textbox.value;
					localStorage.setItem("text",text);
					return text.length
				} else {
					return false
				}
			};

			function loadText() {
				if(!isLocalStorageAvailable) {
					return false
				};
				var _textbox = document.getElementById("mainText");
				if(_textbox) {
					var text = localStorage.getItem("text");
					_textbox.value = text
					return text.length
				} else {
					return false
				}
			};
			
			function findFirstVowelInNijiString(text) {
				return text.match(/[ÓµÄÓµÅÓµÇÓµÉÓµÑ]/)?.[0] ?? null
			};
			
			function capitalizeFirstLetter(string,locale=null) {
				return string[0][locale ? "toLocaleUpperCase" : "toUpperCase"](locale) + string.slice(1)
			};

			function sfcp(...args) {
				return String.fromCodePoint(...args)
			}
		</script>
	</head>
	<body>
		<h1>Niji keyboard</h1>
		<div id="description">
			<p>This is a quick-and-dirty keyboard for the <a href="https://norbertlindenberg.com/2018/03/niji-script/index.html">Norbert Lindenberg's <em>Niji</em> script</a>. Norbert's font (<em>Monnaka Plain</em>) does all of the rendering work (which is impressive). This tool just lets you type in the script.</p><br/>
			
			<p>This script is encoded in the <a href="https://en.wikipedia.org/wiki/Private_Use_Areas">Unicode <em>Private Use Area</em></a> and will not render properly on most pages<sup><small class="tiny"> </small><a href="#footnote-1" class="footnote">1</a></sup> unless you <a href="https://norbertlindenberg.com/shared/MonnakaPlain.ttf">install the font</a><sup><small class="tiny"> </small><a href="#footnote-2" class="footnote">2</a></sup></p><br/>

			<p class="cursed"></p>

			<p>This page does have some bugs which I cannot for the life of me fix. Be warned.</p><br/>
			
			<div id="bottom">
				<div id="footnotes">
					<ol>
						<li id="footnote-1">The exceptions where it will render even without installing the font are pages that embed the special font as a <a href="https://developer.mozilla.org/en-US/docs/Learn/CSS/Styling_text/Web_fonts">web font</a>; of those, I only know about this page and N. Lindenberg's website.</li>
						<li id="footnote-2">This may be complicated or impossible on certain systems, which <em>is not Lindenberg's fault</em>.</li>
					</ol>
				</div>
				<br/>
			</div>
		</div>
		<textarea id="mainText"></textarea>
		<table id="buttons">
			<tbody>
				<tr id="labelrow0">
					<td><div class="spacer">&nbsp;</div></td>
				</tr>
				<tr id="buttonrow0" metaheading="^consonants">
					<td><button title="(No consonant)" labeloverride="‚àÖ">ÓµÖ</button></td>
					<td><button title="K">ÓµÜ</button></td>
					<td><button title="S">Óµà</button></td>
					<td><button title="Sh">Óµä</button></td>
					<td><button title="T">Óµå</button></td>
					<td><button title="Ch">Óµé</button></td>
					<td><button title="Ts">Óµê</button></td>
					<td><button title="N">Óµí</button></td>
					<td><button title="H">Óµì</button></td>
					<td><button title="F">Óµñ</button></td>
					<td><button title="M">Óµò</button></td>
					<td><button title="Y">Óµô</button></td>
					<td><button title="R">Óµö</button></td>
					<td><button title="W">Óµõ</button></td>
					<td><button title="G">Óµá</button></td>
					<td><button title="Z">Óµâ</button></td>
					<td><button title="J">Óµè</button></td>
					<td><button title="D">Óµç</button></td>
					<td><button title="B">Óµï</button></td>
					<td><button title="P">Óµî</button></td>
					<td><button title="V">Óµó</button></td>
				</tr>
				<tr id="labelrow1">
					<td><div class="spacer">&nbsp;</div></td>
				</tr>
				<tr id="buttonrow1" metaheading="^vowels + other">
					<td><button title="A">ÓµÄ</button></td>
					<td><button title="I">ÓµÅ</button></td>
					<td><button title="U">ÓµÇ</button></td>
					<td><button title="E">ÓµÉ</button></td>
					<td><button title="O">ÓµÑ</button></td>
					<td><button title="Ya">ÓµôÓµÄ</button></td>
					<td><button title="Yu">ÓµôÓµÇ</button></td>
					<td><button title="Ye">ÓµôÓµÉ</button></td>
					<td><button title="Yo">ÓµôÓµÑ</button></td>
					<td><button title="Length mark" labeloverride="„Éº">Óµü</button></td>
					<td><button title="(Space)" labeloverride="‚å¥" textoverride=" ">&nbsp;</button></td>
					<td><button title="(New line)" labeloverride="‚èé" textoverride="&#10;">&nbsp;</button></td>
					<td><button title="(Backspace)" labeloverride="‚å´" textoverride="&#8;" style="font-size: 80%">‚êà</button></td>
					<td><button title="(Tab)" labeloverride="‚≠æ" textoverride="&#9;" style="font-size: 80%">‚≠æ</button></td>
					<td class="hidden"><button title="(Zero-width joiner)" labeloverride="ZWJ" textoverride="&#8205;" style="font-size: 60%; line-height: 80%; text-align: center;">ZW<br/>J</button></td>
				</tr>
				<tr id="labelrow2">
					<td><div class="spacer">&nbsp;</div></td>
				</tr>
				<tr id="buttonrow2" class="hidden" metaheading="^long vowel ligatures">
					<td><button title="Aa">ÓµÄ‚ÄçÓµü</button></td> <!--ƒÄ unsupported-->
					<td><button title="Ii">ÓµÅ‚ÄçÓµü</button></td> <!--ƒ™ unsupported-->
					<td><button title="Uu">ÓµÇ‚ÄçÓµü</button></td> <!--≈™ unsupported-->
					<td><button title="Ei">ÓµÉ‚ÄçÓµü</button></td> <!--ƒí unsupported-->
					<td><button title="Ou">ÓµÑ‚ÄçÓµü</button></td> <!--≈å unsupported-->
					<td><button title="Yaa">Óµô‚ÄçÓµÄ‚ÄçÓµü</button></td>
					<td><button title="Yuu">Óµô‚ÄçÓµÇ‚ÄçÓµü</button></td>
					<td><button title="Yei">Óµô‚ÄçÓµÉ‚ÄçÓµü</button></td>
					<td><button title="You">Óµô‚ÄçÓµÑ‚ÄçÓµü</button></td>
				</tr>
				<tr id="labelrow3">
					<td><div class="spacer">&nbsp;</div></td>
				</tr>
				<tr id="buttonrow3" class="cursed" metaheading="^cursed (not in ^niji)">
					<td><button title="Dj">Óµû</button></td>
					<td><button title="Dz">Óµë</button></td>
					<td><button title="Ng">Óµù</button></td>
					<td><button title="L">Óµú</button></td>
					<td><button title="Yi">ÓµôÓµÅ</button></td>
					<td><button title="Yii">Óµô‚ÄçÓµÅ‚ÄçÓµü</button></td>
				</tr>
			</tbody>
		</table><br/><br/>
		<script>
			var everyFifthInputCounter = 0;
			function everyFifthInputSaveHandler() {
				if(everyFifthInputCounter < 0) { everyFifthInputCounter = 0 };
				everyFifthInputCounter++;
				if(everyFifthInputCounter >= 5) {
					saveText();
					everyFifthInputCounter %= 5
				}
			};
		
			nijiConversionKey = {
				[null]: "ÓµÖ",
				"": "ÓµÖ",
				a: "ÓµÄ",
				i: "ÓµÅ",
				u: "ÓµÇ",
				e: "ÓµÉ",
				o: "ÓµÑ",
				k: "ÓµÜ",
				s: "Óµà",
				sh: "Óµä",
				"Óµàh": "Óµä",
				t: "Óµå",
				ch: "Óµé",
				ts: "Óµê",
				"Óµås": "Óµê",
				n: "Óµí",
				h: "Óµì",
				f: "Óµñ",
				m: "Óµò",
				y: "Óµô",
				r: "Óµö",
				w: "Óµõ",
				g: "Óµá",
				z: "Óµâ",
				j: "Óµè",
				d: "Óµç",
				b: "Óµï",
				p: "Óµî",
				v: "Óµó"
			};
			
			if(doCursed) {
				var cursedNijiLetters = {
					"Óµçz": "Óµë",
					dz: "Óµë",
					l: "Óµú",
					"Óµíg": "Óµù",
					ng: "Óµù",
					"Óµçj": "Óµû",
					dj: "Óµû"
				};
				for(var key in cursedNijiLetters) {
					nijiConversionKey[key] = cursedNijiLetters[key]
				}
			};
			
			var englishVowels = "aiueo".split("");
			
			var nijiVowels = englishVowels.map(x => nijiConversionKey[x]);
			
			var nijiVowelsAndChouonpu = nijiVowels.concat("Óµü");
			
			var isVowelRegex = RegExp(`^[${nijiVowels.join("")}]$`);
			
			//for some reason this regex method is necessary or else it Illogically excludes a lot of consonants
			var nijiConsonants = Array.from(new Set(Object.values(nijiConversionKey))).filter(letter => letter.match(isVowelRegex) === null);
			
			var nijiConsonantsAndLengthMark = nijiConsonants.concat("Óµü");

			var lastVowelTypedBeforeLengthMark = null;
			
			var zwnj = "‚Äå";
			var zwj = "‚Äç";
			
			var _newCursorSelectionStart = 0;
			var _newCursorSelectionEnd = 0;
			
			var textbox = document.getElementById("mainText");
			
			function logEdges() {
				console.log(_newCursorSelectionStart,_newCursorSelectionEnd)
			};
			
			function logInTheFont(oneText) {
				console.log(`%c${oneText}`,'font-family: "Monnaka Plain", Consolas;')
			};
			
			//make clicks update the stored cursor position
			textbox.addEventListener("click",function(e) {
				_newCursorSelectionStart = e.target.selectionStart;
				_newCursorSelectionEnd = e.target.selectionEnd;
				//logEdges()
			});

			//make arrow presses update the stored cursor position
			textbox.addEventListener("keyup",function(e) {
				if(e.keyCode >= 37 && e.keyCode <= 40) {
					_newCursorSelectionStart = e.target.selectionStart;
					_newCursorSelectionEnd = e.target.selectionEnd
				};
				//logEdges()
			});

			textbox.addEventListener("focusout",saveText);

			//main roman-to-niji typing code (dirty hacks)
			textbox.addEventListener("input",function(e) {
				_newCursorSelectionStart = e.target.selectionStart;
				_newCursorSelectionEnd = e.target.selectionEnd
				var text = this.value;
				
				var resultingStringBeforeCursor = text.slice(0,_newCursorSelectionStart);
				var resultingStringAfterCursor = text.slice(_newCursorSelectionEnd);
				var last3 = resultingStringBeforeCursor.slice(-3).toLowerCase();
				var last2 = resultingStringBeforeCursor.slice(-2).toLowerCase();
				var last1 = resultingStringBeforeCursor.slice(-1).toLowerCase();
				switch(last2) {
					case "sh":
					case "Óµàh":
					case "ch":
						if(last3[0] == "c") {
							resultingStringBeforeCursor = resultingStringBeforeCursor.replace(/[ctÓµå][cÓµé]h?$/i,"ÓµêÓµé");
						};
					case "ts":
					case "Óµås":
					case "Óµçz":
					case "dz":
					case "Óµíg":
					case "ng":
					case "Óµçj":
					case "dj":
						if(nijiConversionKey[last2]) {
							resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last2 + "$","i"),nijiConversionKey[last2]);
							this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
							_newCursorSelectionStart--;
							_newCursorSelectionEnd--;
							break
						};
					default:
						if((nijiConsonants.includes(last2[0])) && (last2[0] !== "Óµí") && (last2[0] !== "Óµô") && last2[0] == nijiConversionKey[last1]) { //auto-tsuing except for Ns and Ys
							var regex = RegExp(`${last2[0]}(${last1})$`,"i");
							//console.log(regex,resultingStringBeforeCursor.match(regex));
							resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(`${last2[0]}(${last1})$`,"i"),"Óµê$1");
							this.value = resultingStringBeforeCursor+resultingStringAfterCursor
						} else if(last3.startsWith("ÓµôÓµô")) { //special handling for double Ys
							resultingStringBeforeCursor = resultingStringBeforeCursor.replace(/ÓµÖÓµô(Óµô.)/,"ÓµêÓµÖ$1");
							this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
						};
						//console.log(`%c${last2[0]} ${(!(nijiVowels.includes(last2[0]))).toString()} ${(last2[0] !== "Óµô").toString()}`, 'font-family: "Monnaka Plain"')
						switch(last1) {
							case "y":
								if(last2[0] !== "Óµô") { //no Y before Y
									if((resultingStringBeforeCursor.length < 2) || !(nijiConsonants.includes(last2[0]))) {
										resultingStringBeforeCursor = resultingStringBeforeCursor.slice(0,-1) + "ÓµÖ" + resultingStringBeforeCursor.slice(-1);
										this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
										_newCursorSelectionStart++;
										_newCursorSelectionEnd++;
									}
								};
							case "k":
							case "s":
							case "t":
							case "n":
							case "h":
							case "f":
							case "m":
							case "r":
							case "w":
							case "g":
							case "z":
							case "d":
							case "j":
							case "b":
							case "p":
							case "v":
							case "l":
								var result = nijiConversionKey[last1];
								if((!!(result)) && (typeof(result) === "string") && (typeof(result) !== "undefined") && (result !== undefined) && ((result + "") !== "undefined")) {
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),nijiConversionKey[last1]);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
									break;
								};
							case "~":
								if(doCursed) {
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),zwj);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor
								};
								break;
							/*case "'":
								if(last2[0] == "Óµí") {
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),ZWNJ);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
									textbox.selectionStart = _newCursorPosition + 1;
									textbox.selectionEnd = _newCursorPosition + 1;
									break
								};
							*/
							case "a":
							case "i":
							case "u":
							case "e":
							case "o":
								if(nijiConsonants.includes(last2[0])) {
									lastVowelTypedBeforeLengthMark = last1;
									if((!doCursed) && last2[0] == "Óµô" && last1 == "i") {
										resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),zwnj + nijiConversionKey[last1]);
										_newCursorSelectionStart++;
										_newCursorSelectionEnd++;
									} else {
										resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),nijiConversionKey[last1]);
									}
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
								} else if((nijiVowelsAndChouonpu.includes(last2[0]) || (doCursed && (last2[0] === zwj))) && (lastVowelTypedBeforeLengthMark === last1)) {
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),"Óµü");
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
								} else {
									lastVowelTypedBeforeLengthMark = last1;
									resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(last1 + "$","i"),"ÓµÖ" + nijiConversionKey[last1]);
									this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
									_newCursorSelectionStart++;
									_newCursorSelectionEnd++;
								};
								break;
						}
				};
				textbox.selectionStart = _newCursorSelectionStart;
				textbox.selectionEnd = _newCursorSelectionEnd;
				if(localStorageIsAvailable) { everyFifthInputSaveHandler() }
			});
			
			var _uppercaseCaretFunction = function(match) {
				return match[1].toUpperCase()
			};
			
			//Unfixable, undebuggable bug causes buttons to just not work on Safari. No error message, they just don't do anything.
			//https://stackoverflow.com/questions/7944460/detect-safari-browser
			var isSafari = 
						   (urlParams.get("safariOverride") !== null) || (
						   navigator.vendor && navigator.vendor.indexOf('Apple') > -1 &&
						   navigator.userAgent &&
						   navigator.userAgent.indexOf('CriOS') == -1 &&
						   navigator.userAgent.indexOf('FxiOS') == -1 );

			var keyboard = document.getElementById("buttons");
			if(keyboard) {
				if(isSafari) {
					var noSafariMessage = document.createElement("p");
					noSafariMessage.setAttribute("id","noSafariMessage");
						noSafariMessage.innerText = "The in-page button keyboard silently fails on Safari, with the buttons just not doing anything. As I don't have a Mac to debug it with, I sadly have to hide the button keyboard instead. You can still type in Niji by clicking on the text box and using the regular keyboard.";
					keyboard.before(noSafariMessage);
					keyboard.style.display = "none"
				} else {
					var rows = keyboard.querySelectorAll('tr[id^="buttonrow"]') ?? [];
					var rowIndices = Array.from(rows).map(n => n.getAttribute("id").match(/\d+$/)?.[0]).filter(s => !!s).map(x => parseInt(x));
					if(rowIndices.length > 0) {
						var highestIndex = Math.max(...rowIndices);
						var lowestIndex = Math.min(...rowIndices);
						for(var i = lowestIndex; i <= highestIndex; i++) {
							//get button and label rows
							var buttonRow = document.getElementById(`buttonrow${i.toString()}`);
							var labelRow = document.getElementById(`labelrow${i.toString()}`);
							
							//create missing label rows
							if(!labelRow) {
								labelRow = document.createElement("tr");
								labelRow.setAttribute("id",`labelrow${i.toString()}`);
								buttonRow.before(labelRow)
							};
							
							buttonRow.classList.forEach(className => labelRow.classList.add(className));
							
							//clear label row
							var lrcn = labelRow.childNodes;
							for(var j = 0; j < lrcn.length; j++) {
								labelRow.removeChild(lrcn[j]);
								lrcn[j].outerHTML = "";
								lrcn[j] = null
							};
							
							//get buttons
							var buttons = buttonRow.querySelectorAll("button");
							
							//make header
							var labelText = (buttonRow.getAttribute("metaheading") ?? "").replace(/\^(.)/g,_uppercaseCaretFunction)
							var newHeader = document.createElement("th");
							newHeader.setAttribute("rowspan","2");
								newHeader.innerText = labelText;
							labelRow.appendChild(newHeader);
							
							//do buttON stuff
							for(var j = 0; j < buttons.length; j++) {
								var button = buttons[j];
								
								//create labels
								var labelText = ((button.getAttribute("labeloverride") ?? button.getAttribute("title")) ?? "").toLowerCase();
								var newLabel = document.createElement("th");
								button.parentElement.classList.forEach(className => newLabel.classList.add(className));
									var newDiv = document.createElement("div");
										newDiv.innerText = labelText;
									newLabel.appendChild(newDiv)
								labelRow.appendChild(newLabel)
								
								//make the buttons actually work
								button.addEventListener("click",function() {
									try {
										var text = textbox.value;
										
										var textToAdd = this.getAttribute("textoverride") ?? this.innerText;
										var isBackspace = (textToAdd == "\x08");

										if(isBackspace) {
											if(_newCursorSelectionEnd < _newCursorSelectionStart) { _newCursorSelectionEnd = _newCursorSelectionStart };
											if(_newCursorSelectionEnd == 0) { return };
											resultingStringBeforeCursor = text.slice(0,_newCursorSelectionStart - (_newCursorSelectionStart == _newCursorSelectionEnd));
											resultingStringAfterCursor = text.slice(_newCursorSelectionEnd);
											_newCursorSelectionStart -= (_newCursorSelectionStart == _newCursorSelectionEnd);
										} else {
											resultingStringBeforeCursor = text.slice(0,_newCursorSelectionStart) + textToAdd;
											resultingStringAfterCursor = text.slice(_newCursorSelectionEnd);
											_newCursorSelectionStart += textToAdd.length;

											var last3 = resultingStringBeforeCursor.slice(-3).toLowerCase();
											var last2 = resultingStringBeforeCursor.slice(-2).toLowerCase();
											var last1 = resultingStringBeforeCursor.slice(-1).toLowerCase();

											var searchArea = resultingStringBeforeCursor.replace(/Óµü+$/,"").slice(0,-(textToAdd.length));
											var lastVowel = findFirstVowelInNijiString(searchArea.split("").toReversed().join(""));

											if(nijiConsonants.includes(last2[0]) && (last2[0] !== "Óµí") && (textToAdd !== "Óµô") && (last2[0] == last1)) {
												if(last2[0] !== "Óµô") {
													var regex = RegExp(`(${last2[0]})\\1$`,'i');
													resultingStringBeforeCursor = resultingStringBeforeCursor.replace(regex,"Óµê$1")
												}
											};
											
											var lastLetterBeforeTTA = resultingStringBeforeCursor.slice(-(textToAdd.length + 2),-(textToAdd.length + 1)) ?? null;
											//logInTheFont("llbTTA: " + (lastLetterBeforeTTA ?? "null"));
											//logInTheFont("lastVowel: " + lastVowel);
											if(findFirstVowelInNijiString(textToAdd) !== null) {
												//logInTheFont("last2[0]: " + last2[0]);
												if(nijiConsonants.includes(last2[0]) && (last2[0] !== "Óµô")) {
													//console.log("case 1");
												} else if((lastVowel === findFirstVowelInNijiString(textToAdd)) && (lastVowel !== null) && (textToAdd.length == 1)) {
													//console.log("case 2");
													resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(textToAdd + "$","i"),"Óµü");
													this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
												} else {
													//console.log("case 3");
													//Automatically places the ieung analog
													var lastLetter = resultingStringBeforeCursor.slice(-(textToAdd.length + 1), -(textToAdd.length));
													var condition = (
														(last3.length < (2 + (textToAdd.length > 1))) ||
														(!(nijiConsonants.includes(lastLetter)))
													);
													if(condition) {
														resultingStringBeforeCursor = resultingStringBeforeCursor.replace(RegExp(textToAdd + "$","i"),"ÓµÖ" + textToAdd);
														this.value = resultingStringBeforeCursor+resultingStringAfterCursor;
														_newCursorSelectionStart++;
														_newCursorSelectionEnd++
													}
												}
											}
										};
										textbox.value = resultingStringBeforeCursor+resultingStringAfterCursor;
										_newCursorSelectionEnd = _newCursorSelectionStart
										textbox.selectionStart = _newCursorSelectionStart;
										textbox.selectionEnd = _newCursorSelectionEnd;
										if(localStorageIsAvailable) { everyFifthInputSaveHandler() }
									} catch(error) {
										alert(error.stack)
									}
								})
							}
						}
					}
				}
			};

			if(doCursed) {
				var hider = document.getElementById("style2");
				hider.textContent = "";
				hider.innerText = "";
				(document.head ?? document.getElementsByTagName("head")[0]).removeChild(hider);
				
				cursedParagraph = document.querySelector("p.cursed");
				var cpt = [
					"The font has had some letters added (",
					["small","U+ED51 "],
					["span", "Óµû 'dz', ", "as in „Å•"],
					["small","U+ED5C "],
					["span", "Óµù 'l', ", "as in „Çâ„Çö"],
					["small","U+ED5D "],
					["span", "Óµú 'ng', ", "as in „Åã„Çö"],
					["small","U+ED5E "],
					["span", "Óµë 'dj', ", "as in „Å¢"],
					["small","U+ED59-U+ED41 "],
					["span", "ÓµôÓµÅ 'yi'", "as in õÄÜ"],
					") and the discretionary ligatures exposed as ZWJ combinations. You can type a ZWJ by pressing '~'.",
				];
				for(var i = 0; i < cpt.length; i++) {
					var data = cpt[i];
					if((typeof(data) == "string") || (Array.isArray(data) && (data.length == 1))) {
						cursedParagraph.appendChild(document.createTextNode(data))
					} else if(Array.isArray(data) && (data.length > 1)) {
						var newElement = document.createElement(data[0]);
						newElement.innerText = data[1];
						if(data[2]) {
							newElement.setAttribute("title",data[2])
						};
						cursedParagraph.appendChild(newElement)
					}
				};
				cursedParagraph.after(document.createElement("br"));
			}
			
			if(isLocalStorageAvailable) {
				if(localStorage.getItem("text") === null) {
					localStorage.setItem("text","")
				} else {
					loadText();
					textbox.selectionStart = textbox.value.length;
					textbox.selectionEnd = textbox.selectionStart;
					_newCursorSelectionStart = textbox.selectionStart;
					_newCursorSelectionEnd = textbox.selectionEnd
				}
			};
		</script>
		
		<br/><br/><a href="index.html"><small>go to main page</small></a>

	</body>
</html>
